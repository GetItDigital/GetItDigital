% Copyright 2025 Ralf Wegener (ralf.wegener@uni-wuppertal.de) & Josef Kirschner (kirschner@uni-wuppertal.de)
%
% This work may be distributed under the terms of the LPPL.
% See README.md for details.


\def\videoname{videoname} % Variable mit Wert befüllen
\def\videotitel{videotitel} % Variable mit Wert befüllen
\newcommand{\printvideoname}{\videoname}
\newcommand{\printvideotitel}{\videotitel}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamervideo}[2023/10/25 Video creation from beamer slides]
\RequirePackage{ifthen}

\makeatletter
\newwrite\speechouts
\newwrite\speechRenderVideoScript
\newwrite\speechRenderVideoFileList
\newcounter{videopage}

% Zähler zum Überprüfen, ob ein Dokument geöffnet ist (um das Bash-Skript ggf. abzuschließen, bevor ein neues geöffnet wird)
\newif\iffileopened
\fileopenedfalse

% Video-Counter erstellen und auf Null setzten
\newcounter{videocounter}
\setcounter{videocounter}{0}

\newcommand{\newvideofile}[2]{
    \iffileopened
        \docEnd
    \fi

    \def\videoname{#1}
    \def\videotitel{#2}

    %Open other files
    \immediate\openout\speechRenderVideoFileList=\jobname-RenderVideoFilelist-#1.txt
    \immediate\write\speechRenderVideoFileList{file '../Videovorlagen/intro_resample.mp4'}
    \immediate\write\speechRenderVideoFileList{file 'video/video-titel.mp4'}
    \immediate\openout\speechRenderVideoScript=\jobname-RenderVideo-#1.sh
    \stepcounter{videocounter} % Video-Counter um 1 erhöhen
    \docBegin{}{#2}
    \fileopenedtrue
}

\newcommand{\docBegin}[2]{
    \immediate\write\speechRenderVideoScript{\detokenize{eval 'echo "\def\vtitel{#2}" > Videotiteltext.tex' | tr -d ' '}}
    \immediate\write\speechRenderVideoScript{cd ..}
    \immediate\write\speechRenderVideoScript{latexmk -pdf -output-directory=TeXAux VideoTitle.tex}
    \immediate\write\speechRenderVideoScript{cd TeXAuX}
    \immediate\write\speechRenderVideoScript{convert -limit memory 2GB -limit map 2GB -density 350 -colorspace sRGB VideoTitle.pdf video/VideoTitle_\printvideoname.png}
    \immediate\write\speechRenderVideoScript{rm VideoTitle.*}
    \immediate\write\speechRenderVideoScript{ffmpeg -y -loop 1 -i video/VideoTitle_\printvideoname.png -i ../Videovorlagen/Stille4.wav -c:v libx264 -r 25 -vf "scale=-1:1080,pad=1920:1080:(ow-iw)/2:(oh-ih)/2:white" -pix_fmt yuv420p -t 4 -color_trc bt709 -colorspace bt709 -color_primaries bt709 video/video-titel.mp4}
    \immediate\write\speechRenderVideoScript{ffmpeg -y -loop 1 -i video/Folien-1.png -i ../Videovorlagen/Stille4.wav -c:v libx264 -r 25 -vf "scale=-1:1080,pad=1920:1080:(ow-iw)/2:(oh-ih)/2:white" -pix_fmt yuv420p -t 4 -color_trc bt709 -colorspace bt709 -color_primaries bt709 video/video-License.mp4}
}

\newcommand{\docEnd}{
    %Strukturdokument schließen
    \mode<beamer>{
        %Concat all tempory video-files to one video
        \immediate\write\speechRenderVideoScript{ffmpeg -y -f concat -safe 0 -i \jobname-RenderVideoFilelist-\printvideoname.txt -fflags +genpts -c copy ../Videos/\GetItDigitalModulnumber_\thevideocounter_\printvideoname.mp4}

        \immediate\write\speechRenderVideoFileList{file 'video/video-License.mp4'}
        \immediate\write\speechRenderVideoFileList{file '../Videovorlagen/outro_resample.mp4'}
        %write empty line after file list, otherwise last video is missing
        \immediate\write\speechRenderVideoFileList{ }
        %close Files
        \immediate\closeout\speechRenderVideoScript
        \immediate\closeout\speechRenderVideoFileList
    }
}


\newcommand{\speech}[3]{
    \mode<beamer>{
        \only<1>{
            %export Speech-Text in one File per pdf-Page
            \immediate\openout\speechouts=tts-\jobname-#1-#2.txt
            \immediate\write\speechouts{#3}
            \immediate\closeout\speechouts

            %Seitenzahl ermitteln. Das Speech-command ist am Ende der Folien, das commando wird bei der ersten Subpage ausgeführt, die Subpage muss also dazuaddiert und um zwei reduziert werden, da die Nummerierung bei 0 beginnt.
            \setcounter{videopage}{\value{page}}
            \addtocounter{videopage}{#2}
            \addtocounter{videopage}{-2}

            %create video for this slide
            \immediate\write\speechRenderVideoScript{ffmpeg -y -loop 1 -i video/Folien-\arabic{videopage}.png -i ../TTS/tts-\jobname-#1-#2.wav -c:v libx264 -r 25 -vf "scale=-1:1080,pad=1920:1080:(ow-iw)/2:(oh-ih)/2:white" -pix_fmt yuv420p -t XX video/video-#1-#2.mp4}

            %write pause and video filenames to concat-filelist
            \immediate\write\speechRenderVideoFileList{file 'video/video-#1-#2.mp4'}
        }
    }
}

\AtEndDocument{
    \docEnd %Schließt das Bash des letzten Videos des Dokuments ab
}


\makeatother
